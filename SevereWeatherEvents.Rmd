---
title: "Health and Economic Impact of Storm and Severe Weather Events"
author: "Dorian Kcira"
date: "10/19/2015"
output: html_document
---


This analysis is based on a dataset from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. The database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage. The health impact is calculated using the number of fatalities and injuries. The economic impact is calculated using the data from property and crop damage.

# Data Processing

Below we download and unzip the storm data from the NOAA (unless those data have been downloaded and unzipped already).

```{r download}
if (! file.exists("data/StormData.csv")){
  suppressMessages(library(R.utils))
  download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "data/StormData.csv.bz2")
  bunzip2("data/StormData.csv.bz2", "data/StormData.csv")
}
```

Now let's read the data and look at the number of variables and measurements (columns and rows). Let's also print out all column names.

```{R read_data, cache=TRUE}
#knitr::opts_chunk$set(cache=TRUE)
stormdata <- read.csv("data/StormData.csv")
dim(stormdata)
colnames(stormdata)
```


# Results

## Health Impact

**The first question: Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?**


First let's see how many unique event types are there in the dataset
```{r event_type}
length(unique(stormdata$EVTYPE))
```

In order to evaluate the health impact we look at the numbers of fatalities and injuries. We find out which event type has the largest fatalities and injuries by averaging them over the different event types, then sorting. This method is useful for calculating the health impact per event, if we were interested in the total impact of all events of the same type, we would use sums instead of means or medians.

After sorting, we plot the first 20 event types with the hightest impact for each case.


```{r fatalities_injuries}
nr = 20 # number of events types to plot
# I did check that there are no NAs, so na.rm=true is not really necessary
medianFatalities <- tapply(stormdata$FATALITIES, stormdata$EVTYPE, mean, na.rm = TRUE, simplify=TRUE)
largestFatalities = tail(sort(medianFatalities), nr)
medianInjuries <- tapply(stormdata$INJURIES, stormdata$EVTYPE, mean, na.rm = TRUE, simplify=TRUE)
largestInjuries = tail(sort(medianInjuries), nr)
# plot using barchart from lattice, because it has the nice vertical axis with the labels
library(lattice)
par(mfrow=c(1,2))
plot1 <- barchart(largestFatalities, main="Highest fatalities", xlab="fatalities")
plot2 <- barchart(largestInjuries,   main="Highest injuries"  , xlab="injuries")
print(plot1, position = c(0, 0, 0.5, 1), more = TRUE)
print(plot2, position = c(0.5, 0, 1, 1))
```

As we can see from the plots, Tornadoes are the ones with the highest fatalities and heat waves the ones with most injuries. We could combine fatalities and injuries with weight factors to produce a single scale for the health impact but this is left for a different study.


## Economic Impact

**The second question: Across the United States, which types of events have the greatest economic consequences?**

In order to determine the answer to this question we at property damage (PROPDMG) and crop damage (CROPDMG) but these variables must be combined with the multiplying factors using the respective exponentials in PROPDMGEXP and CROPDMGEXP, respectively. We'll print out the unique elements of those two exponential variables first.

```{r economicImpact}
# print out the values of the exponential and their frequencies
table(stormdata$PROPDMGEXP)
table(stormdata$CROPDMGEXP)
# conversion function for EXP
factor_from_exponential <- function(x){
  if(x == "B" | x == "b"){ # billion
    return(1000000000)
  }else if(x == "M" | x == "m"){ # million
    return(1000000)
  }else if(x=="K" | x=="k"){ # kilo, thousand
    return(1000)
  } else if (x == "H" | x == "h") { # hecto, hundred
    return(100)
  } else if(x == ""){
    return(1)
  } else if (as.integer(x) %in% 0:8){
    return(10^(as.integer(x)))
  } else{
    # there are only a few values of the exponential which I do not understand,
    # so I am zeroing the multiplying factor for the moment.
    # This should have no considerable numerical impact
    return(0)
  }
}
stormdata$economicImpact <- stormdata$PROPDMG + stormdata$CROPDMG

```

# Summary and Conclusions



***********************************************

# Varia

R. Peng's template: http://rpubs.com/rdpeng/13396


   2. Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.

#
## Document Layout

   * Language: Your document should be written in English.
   * Title: Your document should have a title that briefly summarizes your data analysis
   * Synopsis: Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.
   * There should be a section titled Data Processing which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.
   * There should be a section titled Results in which your results are presented.
   * You may have other sections in your analysis, but Data Processing and Results are required.
   * The analysis document must have at least one figure containing a plot.
   * Your analyis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.
   * You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).

## Publishing Your Analysis

For this assignment you will need to publish your analysis on RPubs.com. If you do not already have an account, then you will have to create a new account. After you have completed writing your analysis in RStudio, you can publish it to RPubs by doing the following:

In RStudio, make sure your R Markdown document (.Rmd) document is loaded in the editor

   1. Click the Knit HTML button in the doc toolbar to preview your document.
   1. In the preview window, click the Publish button.
   1. Once your document is published to RPubs, you should get a unique URL to that document. Make a note of this URL as you will need it to submit your assignment.

NOTE: If you are having trouble connecting with RPubs due to proxy-related or other issues, you can upload your final analysis document file as a PDF to Coursera instead.